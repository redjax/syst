---
name: Vulnerability Scan

on:
  workflow_call: {}
  workflow_dispatch: {}
  #  Disabled until I can get it to work
  # schedule:
    ## Every day at 1am
    # - cron: '0 1 * * *'

jobs:
  vulnerability-scan:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Extract Go version from go.mod
        id: go-version
        run: |
          GO_VERSION=$(grep '^go ' go.mod | awk '{print $2}')
          echo "version=$GO_VERSION" >> $GITHUB_OUTPUT
          echo "Detected Go version: $GO_VERSION"
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ steps.go-version.outputs.version }}
      
      - name: Run vulnerability scan script
        id: vuln-scan
        continue-on-error: true
        run: |
          chmod +x ./scripts/vuln-scan.sh
          ./scripts/vuln-scan.sh
          echo "exit_code=$?" >> $GITHUB_OUTPUT
      
      - name: Upload vulnerability reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-reports
          path: vulnerability-reports/
      
      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: vulnerability-reports/govulncheck-report.sarif
          category: govulncheck
        continue-on-error: true
      
      - name: Check scan results
        if: always()
        run: |
          if [ -f vulnerability-reports/govulncheck-report.txt ]; then
            echo "::group::Govulncheck Results"
            cat vulnerability-reports/govulncheck-report.txt
            echo "::endgroup::"
          fi
          
          if [ -f vulnerability-reports/gosec-report.txt ]; then
            echo "::group::Gosec Results Summary"
            tail -n 20 vulnerability-reports/gosec-report.txt
            echo "::endgroup::"
          fi
      
      - name: Fail if vulnerabilities found
        if: steps.vuln-scan.outputs.exit_code != '0'
        run: |
          echo "::error::Vulnerabilities found! Check the vulnerability-reports artifact for details."
          exit 1

