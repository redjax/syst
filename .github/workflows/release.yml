---
name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v2.0.0 for major, leave empty for auto)'
        required: false
        type: string

permissions:
  contents: write
  packages: write

jobs:
  check-commits:
    name: Check if release is needed
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      is_manual: ${{ steps.check.outputs.is_manual }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for releasable commits
        id: check
        run: |
          # Manual trigger - always release
          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "is_manual=true" >> $GITHUB_OUTPUT
          echo "Manual trigger - will release"

  security-scan:
    name: Run security scans
    needs: check-commits
    if: needs.check-commits.outputs.should_release == 'true'
    uses: ./.github/workflows/secrets-scan.yml
    permissions:
      actions: read
      contents: read
      security-events: write

  vulnerability-scan:
    name: Run vulnerability scan
    needs: check-commits
    if: needs.check-commits.outputs.should_release == 'true'
    uses: ./.github/workflows/osv-scan.yml
    permissions:
      actions: read
      contents: read
      security-events: write

  release:
    name: Create release
    needs: [check-commits, security-scan, vulnerability-scan]
    if: needs.check-commits.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ## Full history needed for svu
          fetch-depth: 0

      - name: Extract Go version from go.mod
        id: go-version
        run: |
          GO_VERSION=$(grep '^go ' go.mod | awk '{print $2}')
          echo "version=$GO_VERSION" >> $GITHUB_OUTPUT
          echo "Detected Go version: $GO_VERSION"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ steps.go-version.outputs.version }}
          cache: false

      - name: Install cross-compilation toolchains
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu gcc-mingw-w64-x86-64

      - name: Install svu
        run: |
          echo "Installing svu"
          go install github.com/caarlos0/svu@latest

      - name: Debug git state
        run: |
          echo "=== Git Tags ==="
          git tag -l | sort -V | tail -5
          echo ""
          echo "=== Latest tag ==="
          git describe --tags --abbrev=0
          echo ""
          echo "=== Commits since latest tag ==="
          LATEST_TAG=$(git describe --tags --abbrev=0)
          git log ${LATEST_TAG}..HEAD --oneline
          echo ""
          echo "=== What svu thinks ==="
          echo "Current: $(svu current --strip-prefix)"
          echo "Next patch: $(svu patch --strip-prefix)"
          echo "Next minor: $(svu minor --strip-prefix)"
          echo "Next major: $(svu major --strip-prefix)"

      - name: Determine version
        id: version
        run: |
          ## Check if manual version was provided
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "Manual version specified: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT

          else
            ## Auto-calculate next version based on conventional commits
            ## Use git tag --sort to find highest version tag globally (not just in current branch)
            CURRENT=$(git tag --list --sort=-version:refname | head -1 || echo "0.0.0")
            [[ -z "$CURRENT" ]] && CURRENT="0.0.0"
            echo "Current version: $CURRENT"
            
            ## Get commits since last tag
            if [[ "$CURRENT" == "0.0.0" ]]; then
              ## No tags exist yet, check all commits
              COMMITS=$(git log --pretty=format:"%s")
            else
              ## Get commits since last tag
              COMMITS=$(git log ${CURRENT}..HEAD --pretty=format:"%s")
            fi
            
            echo "Commits since last tag:"
            echo "$COMMITS"
            echo ""
            
            ## Count commits to ensure we have any
            COMMIT_COUNT=$(echo "$COMMITS" | grep -v '^$' | wc -l)
            echo "Number of commits since last tag: $COMMIT_COUNT"
            
            if [[ $COMMIT_COUNT -eq 0 ]]; then
              echo "❌ No commits since last tag. Nothing to release."
              exit 1
            fi
            
            ## Check for feat: commits (minor bump)
            if echo "$COMMITS" | grep -qE "^feat(\(.+\))?:"; then
              echo "✅ Found 'feat:' commits, bumping minor version"
              VERSION=$(svu minor --strip-prefix)
              echo "New version: $VERSION"
              echo "version=$VERSION" >> $GITHUB_OUTPUT

            ## Check for fix: commits (patch bump)
            elif echo "$COMMITS" | grep -qE "^fix(\(.+\))?:"; then
              echo "✅ Found 'fix:' commits, bumping patch version"
              VERSION=$(svu patch --strip-prefix)
              echo "New version: $VERSION"
              echo "version=$VERSION" >> $GITHUB_OUTPUT

            else
              echo "⚠️ No 'feat:' or 'fix:' commits found in commit messages."
              echo "Commits examined:"
              echo "$COMMITS"
              exit 1
            fi
          fi

      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "❌ Tag ${{ steps.version.outputs.version }} already exists, aborting"
            exit 1
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "✅ Tag ${{ steps.version.outputs.version }} does not exist, proceeding with release"
          fi

      - name: Set git tag for GoReleaser
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.version }}" -m "Release ${{ steps.version.outputs.version }}"
          git push origin "${{ steps.version.outputs.version }}"

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean --parallelism 4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
