---
name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v2.0.0 for major, leave empty for auto)'
        required: false
        type: string

permissions:
  contents: write
  packages: write

jobs:
  check-commits:
    name: Check if release is needed
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      is_manual: ${{ steps.check.outputs.is_manual }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for releasable commits
        id: check
        run: |
          # Manual trigger - always release
          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "is_manual=true" >> $GITHUB_OUTPUT
          echo "Manual trigger - will release"

  security-scan:
    name: Run security scans
    needs: check-commits
    if: needs.check-commits.outputs.should_release == 'true'
    uses: ./.github/workflows/secrets-scan.yml
    permissions:
      actions: read
      contents: read
      security-events: write

  vulnerability-scan:
    name: Run vulnerability scan
    needs: check-commits
    if: needs.check-commits.outputs.should_release == 'true'
    uses: ./.github/workflows/osv-scan.yml
    permissions:
      actions: read
      contents: read
      security-events: write

  release:
    name: Create release
    needs: [check-commits, security-scan, vulnerability-scan]
    if: needs.check-commits.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ## Full history needed for svu
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          ## Check current release version at https://go.dev/doc/devel/release
          go-version: '1.23.5'
          cache: false

      - name: Install cross-compilation toolchains
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu gcc-mingw-w64-x86-64

      - name: Install svu
        run: |
          echo "Installing svu"
          go install github.com/caarlos0/svu@latest

      - name: Determine version
        id: version
        run: |
          ## Check if manual version was provided
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "Manual version specified: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT

          else
            ## Auto-calculate next version based on conventional commits
            CURRENT=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            echo "Current version: $CURRENT"
            
            ## Get commits since last tag
            if [[ "$CURRENT" == "v0.0.0" ]]; then
              ## No tags exist yet, check all commits
              COMMITS=$(git log --pretty=format:"%s")
            else
              ## Get commits since last tag
              COMMITS=$(git log ${CURRENT}..HEAD --pretty=format:"%s")
            fi
            
            echo "Commits since last tag:"
            echo "$COMMITS"
            
            ## Check for feat: commits (minor bump)
            if echo "$COMMITS" | grep -qE "^feat(\(.+\))?:"; then
              if [[ "$CURRENT" == "v0.0.0" ]]; then
                VERSION="v0.1.0"
              else
                VERSION=$(svu minor)
              fi
              echo "✅ Found 'feat:' commits, bumping minor version to $VERSION"
              echo "version=$VERSION" >> $GITHUB_OUTPUT

            ## Check for fix: commits (patch bump)
            elif echo "$COMMITS" | grep -qE "^fix(\(.+\))?:"; then
              if [[ "$CURRENT" == "v0.0.0" ]]; then
                VERSION="v0.0.1"
              else
                VERSION=$(svu patch)
              fi
              echo "✅ Found 'fix:' commits, bumping patch version to $VERSION"
              echo "version=$VERSION" >> $GITHUB_OUTPUT

            else
              echo "⏭️ No 'feat:' or 'fix:' commits found. This shouldn't happen."
              exit 1
            fi
          fi

      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "❌ Tag ${{ steps.version.outputs.version }} already exists, aborting"
            exit 1
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "✅ Tag ${{ steps.version.outputs.version }} does not exist, proceeding with release"
          fi

      - name: Set git tag for GoReleaser
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.version }}" -m "Release ${{ steps.version.outputs.version }}"

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean --parallelism 4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
